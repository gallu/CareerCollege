# 2019年度 後期 期末試験

試験の回答は、以下の通りにすること。

- １問あたり１ファイルに記述。ファイル名は「1-1.txt」でも「問1-1.txt」でも可。フォーマットはtext、拡張子は.txtとする
- 文字コードはUTF-8にすること

試験の注意事項は以下の通り

- 試験なので「周囲との相談」「他人の答案の覗き見」は不許可
- ネット等を使って調べるのは許可
- コードやSQLを勉強用サーバ(dev2.m-fr.net)で確認するのは推奨
- いずれの問題も「書いてある点数」を満点とし、問題があったら適宜減点する

提出は、以下の通り

- 授業内に提出する場合は、ファイルサーバ内の所定のフォルダの中に「自分の名前のフォルダ」を作成して、そこに回答ファイル一式を提出
- 授業外で提出する場合は「自分の名前のフォルダ」に回答ファイル一式を入れた状態でzip形式で固めて教務経由で提出(提出期限は1/30)

## クラスの継承


以下のクラスが存在します。
```
class Hoge
{
    public function __construct()
    {
        echo __METHOD__ , "\n";
    }
}
```

### (問1-1): 5点

class Hoge を継承したclass Foo のプログラムを書きなさい。


### (問1-2): 5点

上述のclass Fooで、コンストラクタを実装しなさい。    
処理は以下の通りとします。    

- 親クラス(Hoge)のコンストラクタを実行する
- 'Foo#construct' と出力する


## マジックメソッド

以下の実装を、PHPのマジックメソッドを使って実装しなさい。    

### (問2-1) __set()/ __get(): 5点

「アクセス不能なプロパティ(存在していないプロパティ / 外部からのpriveteやprotectedなプロパティへのアクセス)」に値を入れる、若しくは値を参照しようとしたときに「エラーメッセージを出力する」コードを実装しなさい。    
エラーメッセージには「どんな名前のプロパティにアクセスしようとしていたか」を含めなさい。    

### (問2-2) __construct() / __destruct(): 5点

「newでインスタンスを作った瞬間」および「インスタンスが破棄される瞬間」に動くメソッドを実装しなさい。    
newされた瞬間のメソッドでは"Create"、破棄される瞬間のメソッドでは"Destroying"の文字列を出力(echo)しなさい。    

## (問3)PDOを使ったSQLの発行: 10点

以下のコードを書きなさい。    

- PDOを使ってDBに接続。情報は「mysql、localhost、database名はtech、接続アカウントとパスワードはtech」
- 以下のテーブルに対して情報をINSERT。なお、created_at以外の情報は「外部から入ってきた」ものと仮定して、セキュリティに配慮すること

INSERTする値は    

- name には自分の名前
- quantity には好きな数値
- created_atには「今」の時間を、PHPまたはMySQLの関数を使用

とします。    

```
CREATE TABLE f_exam (
  f_exam_id SERIAL,
  name VARCHAR(64) NOT NULL DEFAULT '' COMMENT '名前',
  quantity INT NOT NULL COMMENT '数量',
  created_at DATETIME NOT NULL COMMENT 'レコード作成日付',
  PRIMARY KEY(f_exam_id)
)CHARACTER SET 'utf8mb4', ENGINE=InnoDB, COMMENT='テストテーブル';

なお、PDO接続で「適切なoptionが指定されていない」場合は減点対象とします。    


## (問4)session: 10点

PHPのセッション関数を使って、以下の実装をしなさい。    

- セッションの開始
- セッションデータに「key:test, value: mt_rand(0, 99)」の値を代入
- 上述で代入した値を表示


## パスワードの保存と比較

以下のテーブルが存在します。    

```
CREATE TABLE users(
  user_id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  email VARBINARY(255) NOT NULL DEFAULT '' COMMENT 'emailアドレス',
  pw VARBINARY(255) NOT NULL COMMENT 'パスワード',
  PRIMARY KEY(user_id)
)CHARACTER SET 'utf8mb4', ENGINE=InnoDB, COMMENT='会員テーブル';
```

### (問5-1)パスワードの保存: 5点

$_POSTから「email」と「password」が入ってきた、と仮定します。    
この条件で、usersテーブルに「emailとpw」を適切に保存してください。    
なお、DBハンドルは「すでに接続されていて、$dbh変数に入っている」「問3のコードを流用する」のどちらでもよいとします。

### (問5-2)パスワードの比較: 5点

$_POSTから「email」と「password」が入ってきた、と仮定します。    
この条件で、「usersからの情報の取得」「パスワードの比較」を適切に処理してください。    
なお、DBハンドルは「すでに接続されていて、$dbh変数に入っている」「問3のコードを流用する」のどちらでもよいとします。

## (問6): 作成物の提出

授業中に作成したものを提出しなさい。    
以下のチェックを行います。    
試験のファイルには「アクセス可能なURI」を記述しなさい。

- ログイン処理: 正しいemailとパスワードでログインができること / 誤ったemailとパスワードでログインができないこと: 10点
- 認可処理: ログイン前にTopPageが見れないこと / ログイン後にTopPageが見れること: 10点
- パスワードリマインダ: パスワードリマインダの機能(emailが送れる、tokenがDBに保存されている、tokenを使ってパスワードが再設定できる)が動いていること: 10点
- 入金と出金:入金および出金が適切に登録できること : 10点
- 一覧の出力:入力データが適切に一覧表示されていること : 10点
