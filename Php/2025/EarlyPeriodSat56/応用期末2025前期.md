# 2025年度 前期 応用 期末試験

試験の回答は、以下の通りにすること。

- １問あたり１ファイルに記述。ファイル名は「問題番号.php(例: 1.php)」とする。拡張子は.phpであること
- 文字コードはUTF-8にすること

試験の注意事項は以下の通り

- 試験なので「周囲との相談」「他人の答案の覗き見」は不許可
- ネット等を使って調べるのは許可
- コードやSQLを実行 / 確認するのは推奨
- いずれの問題も「書いてある点数(記載がない場合は10点)」を満点とし、問題があったら適宜減点する

提出は、以下の通り

- 「自分の名前+各席番号」.zip のファイル名で回答を一式固めて提出

## SQL用テーブルレイアウト

設問に使うSQL用のテーブルは、以下のレイアウトとします。  

```
-- カテゴリ
DROP TABLE IF EXISTS categories;
CREATE TABLE categories (
  category_id SERIAL COMMENT 'カテゴリID',
  category_name VARCHAR(256) NOT NULL COMMENT 'カテゴリ名',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '作成日',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修正日',
  PRIMARY KEY (`category_id`)
)CHARACTER SET 'utf8mb4', ENGINE=InnoDB, COMMENT='1レコードが1カテゴリを意味するテーブル';
```

```
-- 商品
DROP TABLE IF EXISTS items;
CREATE TABLE items (
  item_id SERIAL COMMENT '商品ID',
  item_name VARCHAR(128) NOT NULL COMMENT '商品名',
  category_id BIGINT UNSIGNED NOT NULL COMMENT 'カテゴリID',
  price INT UNSIGNED NOT NULL COMMENT '価格',
  release_at DATETIME DEFAULT NULL COMMENT '発売開始日(NULLなら発売日未定)',
  sale_end_at DATETIME DEFAULT NULL COMMENT '発売終了日(NULLなら発売終了日未定)',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '作成日',
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '修正日',
  CONSTRAINT `fk_items_category_id` FOREIGN KEY (`category_id`) REFERENCES `categories` (`category_id`),
  PRIMARY KEY (`item_id`)
)CHARACTER SET 'utf8mb4', ENGINE=InnoDB, COMMENT='1レコードが1商品を意味するテーブル';
```

dev2.m-fr.net サーバの、ec_sample にこのテーブルが実在するので、ログインして使ってokです。  

```
mysql  -u  ec_sample_user  -p  ec_sample
```

MySQLログインパスワードは  
`ec_sample_pass`
です。  

## (問1) 条件付きSELECT

items テーブルから、以下の条件にすべて当てはまるレコードを取得するSQLを作成してください。  

- price が 500 以上 1000 以下 の商品すべて
- release_at が NULL のデータは除外
- 取得する列は item_name と price のみ
- price の昇順で並べてください

## (問2) JOIN付き

items テーブルと categories テーブルを結合し、全商品の item_name, category_name, price を取得するSQLを作成してください。  
category_id をキーに結合し、price の降順で並べてください。  

## (問3) PHPでSQL文発行

問1のSQLを発行するPHPプログラムを書きなさい。  
条件は以下の通り  

- DBはすでに `$dbh` 変数に入っているものとする
- priceの下限(500)と上限(1000)は、 `$min` と `$max` の変数に入っていて、外部から入力されているものとする
    - セキュリティへの配慮がない場合は大幅に減点対象とする

得られた情報を、var_dump()で全部出力しなさい。  

## (問4) CSVファイルの読み込み

zip.csv というファイルがある。ファイルの形式はCSVである(文字コードは Shift JIS)。  
このファイルを**1行ずつ読み込み**、各行を **UTF-8 に変換**した上で **配列として処理**できるように、PHPコードを書きなさい。  
各行は `var_dump` で出力してよい。  

## (問5) 日付関連

- 現在時刻
- 現在時刻の1週間前
- 現在時刻の30日後

をそれぞれ出力するコードを書きなさい(出力フォーマットは任意とするが、年月日時分秒がすべて含まれていること)。  

## (問6) HTMLからのデータの取得と出力

以下の HTML form がある。  
```
<form action="./6.php" method="post">
  メール <input type="text" name="email"><br>
  コメント <textarea name="comment"></textarea><br>
  <button>送信</button>
</form>
```

この form から **「メール」** と **「コメント」** を取得して **安全に出力**する PHP コードを書きなさい。  
※ XSS 対策（エスケープ）がなされていない場合は大幅に減点する。

## (問7) セッション

7_1.php のファイルで、以下を実装しなさい。

- セッション customer_id に、random_int(1000, 9999) で得られた4桁の乱数を代入する
- セッション customer_name に、任意の名前を代入する
- セッションの内容を var_dump() で表示する

7_2.php のファイルで、以下を実装しなさい。

- セッション customer_id の内容を echo で表示する
- セッション customer_name の内容を echo で表示する

## (問8) 画像アップロードの受け取りと検証

次の HTML フォームから画像ファイルがアップロードされるものとする。  
```
<form action="./8.php" method="post" enctype="multipart/form-data">
  <input type="file" name="image">
  <button>送信</button>
</form>
```

`8.php` を実装し、以下を満たしなさい。

- フォームからアップロードされたファイルを受け取り、エラーがないことを確認する
- `mime_content_type()` を用い、**MIME タイプが `image/jpeg`・`image/png`・`image/gif` のいずれか**であることを検証する  
  - それ以外の場合は `NG` と出力して**処理を終了**する
- **保存用のファイル名**を **UUID v4** で生成する（拡張子は MIME タイプから決定：`.jpg` / `.png` / `.gif`）
- 生成した **「保存するファイル名（文字列）」のみを `echo` で出力**する  
  - ※ 実際のファイル保存（`move_uploaded_file` など）は**行わない**

## (問9) CSVのダウンロード

以下の **配列の配列（2次元配列）** を「元データ」として用意し、このデータを **CSV 形式でダウンロード**させる PHP を実装しなさい。

- 元データは 2次元配列であれば任意(以下のサンプルを使ってもよい)
- HTTPレスポンスヘッダを適切に設定し、ブラウザが CSV ファイルとして認識し、指定したファイル名で保存できるようにすること
- **ファイル名**は `Report_YYYYMMDDHHIISS.csv`（実行時の時刻を使用(YYYYMMDDHHIISS の部分を、実行時の 年月日時分秒 にする)）

元データサンプル
```
$users = [
    [1, 'Tanaka', 25, 'Tokyo'],
    [2, 'Suzuki', 30, 'Osaka'],
    [3, 'Sato',   28, 'Nagoya'],
];
```

## (問10) JSONレスポンスの出力（Web API想定）

API エンドポイントとして、**JSON** を返す PHP を実装しなさい。  
以下の要件をすべて満たすこと。

- HTTPレスポンスヘッダを適切に設定し、ブラウザやクライアントが JSON であると正しく認識できるようにすること
- 次の **PHPの連想配列** を JSON にエンコードして出力すること
- 余計な出力（空白や HTML）は含めないこと（**JSON のみ**を返す）

処理の結果、以下の配列が得られたとする(コピペしてそのまま用いてよい)。  
```php
$data = [
    'status' => 'success',
    'data' => [
        'user' => [
            'id' => 123,
            'name' => 'hoge foo',
            'email' => 'hoge@example.com',
        ],
    ],
    'meta' => [
        'generatedAt' => date(DATE_ATOM), // 実行時の時刻
    ],
];
```

**出力イメージ**：
```json
{"status":"success","data":{"user":{"id":123,"name":"hoge foo","email":"hoge@example.com"}},"meta":{"generatedAt":"2025-08-12T17:38:15+09:00"}}
```
